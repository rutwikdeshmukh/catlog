#!/bin/bash

set -e

RUNTIME_DIR="runtime"
PIDFILE="$RUNTIME_DIR/catlog.pid"
LOGFILE="$RUNTIME_DIR/catlog.log"
BINARY="$RUNTIME_DIR/catlog-server"

# Function to setup nginx
setup_nginx() {
    echo "üåê Catlog - Nginx Setup"
    echo "======================="
    
    # Check if running on Linux
    if [[ "$OSTYPE" != "linux-gnu"* ]]; then
        echo "‚ùå Nginx setup only works on Linux"
        exit 1
    fi
    
    # Check if nginx is installed
    if ! command -v nginx &> /dev/null; then
        echo "üì¶ Installing nginx..."
        
        if command -v apt-get &> /dev/null; then
            sudo apt-get update -qq
            sudo apt-get install -y nginx
        elif command -v yum &> /dev/null; then
            sudo yum install -y nginx
        elif command -v dnf &> /dev/null; then
            sudo dnf install -y nginx
        else
            echo "‚ùå Unsupported Linux distribution. Please install nginx manually."
            exit 1
        fi
    fi
    
    echo "‚úÖ Nginx is installed: $(nginx -v 2>&1)"
    
    # Get public IP
    echo "üåê Detecting public IP..."
    PUBLIC_IP=$(curl -s ifconfig.me || curl -s ipinfo.io/ip || curl -s icanhazip.com || echo "127.0.0.1")
    echo "üìç Detected public IP: $PUBLIC_IP"
    
    # Update config.yml with detected IP and enable SSL
    if [ -f "config.yml" ]; then
        sed -i "s/server_ip: .*/server_ip: \"$PUBLIC_IP\"/" config.yml
        sed -i "s/base_url: .*/base_url: \"\/catlog\"/" config.yml
        sed -i "s/ssl:/ssl:\n  enabled: true/" config.yml
        echo "‚úÖ Updated config.yml with server IP and base_url"
    fi
    
    # Generate SSL certificate if it doesn't exist
    if [ ! -f "/etc/ssl/certs/catlog.crt" ]; then
        echo "üîí Generating SSL certificate..."
        sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
            -keyout /etc/ssl/private/catlog.key \
            -out /etc/ssl/certs/catlog.crt \
            -subj "/C=US/ST=State/L=City/O=Catlog/CN=$PUBLIC_IP" 2>/dev/null
        
        sudo chmod 600 /etc/ssl/private/catlog.key
        sudo chmod 644 /etc/ssl/certs/catlog.crt
        echo "‚úÖ SSL certificate generated"
    else
        echo "‚úÖ SSL certificate already exists"
    fi
    
    # Create nginx config with dynamic IP
    echo "üîß Creating nginx configuration..."
    sed "s/SERVER_IP/$PUBLIC_IP/g" catlog-nginx > /tmp/catlog-nginx-configured
    sudo cp /tmp/catlog-nginx-configured /etc/nginx/sites-available/catlog
    rm /tmp/catlog-nginx-configured
    
    sudo ln -sf /etc/nginx/sites-available/catlog /etc/nginx/sites-enabled/catlog
    
    # Test nginx config
    if sudo nginx -t 2>/dev/null; then
        echo "‚úÖ Nginx configuration is valid"
    else
        echo "‚ùå Nginx configuration has errors"
        exit 1
    fi
    
    # Restart nginx
    sudo systemctl restart nginx 2>/dev/null || sudo service nginx restart 2>/dev/null || sudo nginx -s reload 2>/dev/null || echo "‚ö†Ô∏è  Please restart nginx manually"
    echo "‚úÖ Nginx restarted"
    
    # Setup timezone
    echo "üïê Setting timezone to IST..."
    sudo timedatectl set-timezone Asia/Kolkata 2>/dev/null || echo "‚ö†Ô∏è  Could not set timezone automatically"
    
    echo ""
    echo "üéâ Nginx setup complete!"
    echo "üìç Access via: https://$PUBLIC_IP/catlog"
    echo "‚ö†Ô∏è  Browser will show security warning - click 'Advanced' ‚Üí 'Proceed'"
}

# Function to install and build
install_and_build() {
    echo "üöÄ Catlog - Lightweight Log Viewer Setup"
    echo "======================================="

    # Create runtime directory
    mkdir -p "$RUNTIME_DIR"

    # Check what needs to be installed
    NEED_GO=false
    
    if [[ "$OSTYPE" == "linux-gnu"* ]]; then
        if ! command -v go &> /dev/null; then
            NEED_GO=true
        fi
        
        # Install Go if needed
        if [[ "$NEED_GO" == true ]]; then
            echo "üì¶ Installing Go..."
            
            if command -v apt-get &> /dev/null; then
                sudo apt-get update -qq
                sudo apt-get install -y golang-go
            elif command -v yum &> /dev/null; then
                sudo yum install -y golang
            elif command -v dnf &> /dev/null; then
                sudo dnf install -y golang
            else
                echo "‚ùå Unsupported Linux distribution. Please install Go manually."
                exit 1
            fi
        fi
    elif [[ "$OSTYPE" == "darwin"* ]]; then
        # macOS
        if ! command -v go &> /dev/null; then
            echo "üì¶ Installing Go..."
            if command -v brew &> /dev/null; then
                brew install go
            else
                echo "‚ùå Please install Homebrew first or install Go manually from https://golang.org/dl/"
                exit 1
            fi
        fi
    else
        if ! command -v go &> /dev/null; then
            echo "‚ùå Unsupported OS. Please install Go manually from https://golang.org/dl/"
            exit 1
        fi
    fi

    if command -v go &> /dev/null; then
        echo "‚úÖ Go is installed: $(go version)"
    fi

    # Install dependencies
    echo "üì¶ Installing dependencies..."
    cd src && go mod tidy && cd ..

    # Build the application
    echo "üî® Building catlog..."
    cd src && go build -o "../$BINARY" main.go && cd ..

    # Make it executable
    chmod +x "$BINARY"

    # Setup auto-start on boot (Linux only)
    if [[ "$OSTYPE" == "linux-gnu"* ]]; then
        echo "‚è∞ Setting up auto-start on boot..."
        CURRENT_DIR=$(pwd)
        
        # Check if crontab entry already exists
        if ! crontab -l 2>/dev/null | grep -q "catlog restart"; then
            # Add crontab entry for auto-start (handle empty crontab)
            { crontab -l 2>/dev/null || true; echo "@reboot sleep 60 && cd $CURRENT_DIR && ./catlog restart"; } | crontab -
            echo "‚úÖ Auto-start configured - catlog will restart automatically on server reboot"
        else
            echo "‚úÖ Auto-start already configured"
        fi
    fi

    echo "‚úÖ Catlog installed successfully!"
}

case "$1" in
    start)
        # Check if config.yml exists
        if [ ! -f "config.yml" ]; then
            echo "‚ùå Error: config.yml not found"
            echo "üìù Please copy example.config.yml to config.yml and configure it"
            echo "   cp example.config.yml config.yml"
            exit 1
        fi
        
        # Build if binary doesn't exist
        if [ ! -f "$BINARY" ]; then
            install_and_build
        fi
        
        if [ -f "$PIDFILE" ]; then
            PID=$(cat "$PIDFILE")
            if ps -p "$PID" > /dev/null 2>&1; then
                echo "Catlog is already running (PID: $PID)"
                echo "Access at: http://localhost:8008"
                exit 1
            else
                rm -f "$PIDFILE"
            fi
        fi
        
        echo "üéâ Starting Catlog server..."
        nohup "./$BINARY" > "$LOGFILE" 2>&1 &
        PID=$!
        echo $PID > "$PIDFILE"
        
        sleep 1
        if ps -p "$PID" > /dev/null 2>&1; then
            echo "‚úÖ Catlog started successfully (PID: $PID)"
            echo "üìç Server available at: http://localhost:8008"
            echo "üìÑ Configuration loaded from config.yml"
        else
            echo "‚ùå Failed to start Catlog"
            rm -f "$PIDFILE"
            exit 1
        fi
        ;;
    
    stop)
        echo "üõë Stopping Catlog..."
        
        # Kill by PID file first
        if [ -f "$PIDFILE" ]; then
            PID=$(cat "$PIDFILE")
            if ps -p "$PID" > /dev/null 2>&1; then
                kill -TERM "$PID" 2>/dev/null || true
                sleep 2
                # Force kill if still running
                if ps -p "$PID" > /dev/null 2>&1; then
                    kill -KILL "$PID" 2>/dev/null || true
                fi
            fi
            rm -f "$PIDFILE"
        fi
        
        # Kill any remaining catlog-server processes by name
        pkill -f "catlog-server" 2>/dev/null || true
        sleep 1
        
        # Force kill any stubborn processes
        pkill -9 -f "catlog-server" 2>/dev/null || true
        
        # Kill any process using port 8008
        lsof -ti:8008 2>/dev/null | xargs kill -9 2>/dev/null || true
        
        echo "‚úÖ Catlog stopped"
        ;;
    
    status)
        if [ -f "$PIDFILE" ]; then
            PID=$(cat "$PIDFILE")
            if ps -p "$PID" > /dev/null 2>&1; then
                echo "‚úÖ Catlog is running (PID: $PID)"
                echo "üìç Access at: http://localhost:8008"
            else
                echo "‚ùå Catlog is not running"
                rm -f "$PIDFILE"
            fi
        else
            echo "‚ùå Catlog is not running"
        fi
        ;;
    
    restart)
        # Check if config.yml exists
        if [ ! -f "config.yml" ]; then
            echo "‚ùå Error: config.yml not found"
            echo "üìù Please copy example.config.yml to config.yml and configure it"
            echo "   cp example.config.yml config.yml"
            exit 1
        fi
        
        echo "üîÑ Restarting Catlog..."
        
        # Stop current service
        $0 stop
        
        sleep 2
        
        # Start catlog
        echo "üöÄ Starting Catlog..."
        $0 start
        
        echo ""
        echo "üéâ Catlog restarted successfully!"
        ;;
    
    update)
        echo "üîÑ Updating Catlog..."
        
        # Force stop any running instances
        echo "üõë Stopping any running instances..."
        $0 stop
        
        # Extra cleanup - kill anything on port 8008
        lsof -ti:8008 2>/dev/null | xargs kill -9 2>/dev/null || true
        
        sleep 2
        install_and_build
        
        echo ""
        echo "üöÄ Starting updated server..."
        $0 start
        ;;
    
    uninstall)
        echo "üóëÔ∏è Uninstalling Catlog..."
        
        # Stop server if running
        $0 stop 2>/dev/null || true
        
        # Remove auto-start crontab entry (Linux only)
        if [[ "$OSTYPE" == "linux-gnu"* ]]; then
            echo "‚è∞ Removing auto-start configuration..."
            if crontab -l 2>/dev/null | grep -q "catlog restart"; then
                { crontab -l 2>/dev/null || true; } | grep -v "catlog restart" | crontab -
                echo "‚úÖ Auto-start configuration removed"
            fi
        fi
        
        # Remove runtime directory
        echo "üìÅ Removing runtime files..."
        rm -rf runtime/
        
        # Remove built binary
        rm -f catlog-server
        
        # Remove log and pid files
        rm -f catlog.log catlog.pid
        
        echo "‚úÖ Catlog uninstalled successfully"
        echo "üìù Note: Go package was not removed"
        echo "üìù Note: config.yml was preserved"
        ;;
    
    nginx)
        case "$2" in
            setup)
                setup_nginx
                ;;
            restart)
                echo "üîÑ Restarting nginx..."
                sudo systemctl restart nginx 2>/dev/null || sudo service nginx restart 2>/dev/null || sudo nginx -s reload 2>/dev/null
                echo "‚úÖ Nginx restarted"
                ;;
            stop)
                echo "üõë Stopping nginx..."
                sudo systemctl stop nginx 2>/dev/null || sudo service nginx stop 2>/dev/null || sudo nginx -s stop 2>/dev/null
                echo "‚úÖ Nginx stopped"
                ;;
            remove)
                echo "üóëÔ∏è Removing nginx configuration..."
                sudo rm -f /etc/nginx/sites-enabled/catlog
                sudo rm -f /etc/nginx/sites-available/catlog
                sudo systemctl restart nginx 2>/dev/null || sudo service nginx restart 2>/dev/null || sudo nginx -s reload 2>/dev/null || true
                echo "‚úÖ Nginx configuration removed"
                ;;
            *)
                echo "Usage: catlog nginx {setup|restart|stop|remove}"
                ;;
        esac
        ;;
    
    ""|install)
        install_and_build
        echo ""
        echo "üéâ Installation complete!"
        echo "üìç Run 'catlog start' to start the server"
        echo "üìç Run 'catlog stop' to stop the server"
        echo "üìç For nginx setup, run './catlog nginx setup'"
        ;;
    
    *)
        echo "Usage: catlog {start|stop|status|install|update|restart|uninstall|nginx}"
        echo ""
        echo "Commands:"
        echo "  start              - Start Catlog server in background"
        echo "  stop               - Stop Catlog server"
        echo "  status             - Check if Catlog is running"
        echo "  install            - Install dependencies and build"
        echo "  update             - Stop, rebuild, and restart server"
        echo "  restart            - Restart the server"
        echo "  uninstall          - Remove all catlog files and configurations"
        echo ""
        echo "Nginx Commands (Linux only):"
        echo "  nginx setup        - Install nginx, generate SSL, and configure reverse proxy"
        echo "  nginx restart      - Restart nginx"
        echo "  nginx stop         - Stop nginx"
        echo "  nginx remove       - Remove catlog nginx configuration"
        exit 1
        ;;
esac


